#PBS -N run_all
#PBS -l select=1:ncpus=32:mem=128gb:mpiprocs=32:interconnect=hdr,walltime=47:59:59
#PBS -m abe
#PBS -j oe

#PBS -o run_all.txt

module load anaconda3/2022.05-gcc/9.5.0
module load openmpi/4.1.3-gcc/9.5.0-ucx

source activate sparced
cd /home/jrhuggi/projects/foreman/SPARCED/unit_tests/src
python3 createModel_o4a.py

cd ../
# I dont remember for-loops in bash so I'm writing in python for now
for directory in *; do 
    if [ "$directory" != "src" ] && [ -d "$directory" ]; then
        # Change directory to the 'scripts' directory within each directory
        cd "$directory/scripts/" || continue
        
        # Execute the command
        mpiexec -n 20 python run_unit_tests.py
        
        # Return to the original directory
        cd - >/dev/null || exit
    fi
done
Bootstrap: docker
From: ubuntu:18.04
from: continuumio/miniconda3
%environment
    # Add conda to PATH
    export PATH=/opt/conda/bin:$PATH
    # Set the shell interpreter to use Bash
    export SHELL=/bin/bash

%files
    #First pull in the environment.yml for working container construction. I don't think order matters here.
    $PWD/* /SPARCED/

%post
    # Install system-level dependencies
    apt-get update && apt-get install -y curl git python3-dev python3-pip libhdf5-serial-dev libatlas-base-dev libxml2 swig rsync && ln -s /usr/bin/python3 python

    # Set the shell interpreter to use Bash
    export SHELL=/bin/bash

    # Add Conda to PATH and activate the Conda environment
    export PATH=/opt/conda/bin:$PATH
    . /opt/conda/etc/profile.d/conda.sh  # Activate Conda

    #Create a conda config file defining preinstalled packages necessary for amici & antimony to be installed on build 
    echo "channels:\n  - conda-forge\n  - bioconda\n  - defaults" > /opt/conda/.condarc
    echo "create_default_packages:\n  - pip\n  - openblas\n  - swig\n  - cxx-compiler" >> /opt/conda/.condarc

    # Build operational conda environment
    conda env create -f /SPARCED/environment.yml
    #/opt/conda/bin/conda env create -f environment.yml

    # Add the Conda environment's bin directory to PATH
    export PATH=/opt/conda/envs/sparced/bin:$PATH

    # Activate conda environment
    . activate sparced

    #Append to the .bashrc file so the conda environment is also started on container run
    echo ". activate /opt/conda/envs/sparced" >> ~/.bashrc
    export PATH=/opt/conda/envs/sparced/bin:$PATH

    # Changing working directory in container
    cd /SPARCED

    cd /SPARCED/scripts
    python3 createModel_hpc.py
%runscript
    # Set the shell interpreter to use bash instead of /bin/sh
    exec /bin/bash -c "source /opt/conda/bin/activate sparced && exec /bin/bash"
